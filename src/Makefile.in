#########################################################################
# Makefile for istgt
#########################################################################

top_srcdir = @top_srcdir@
srcdir   = @srcdir@
prefix   = @prefix@
exec_prefix = @exec_prefix@
bindir   = @bindir@
sbindir  = @sbindir@
sysconfdir = @sysconfdir@
datarootdir = @datarootdir@
datadir  = @datadir@
libexecdir = @libexecdir@
mandir   = @mandir@

CC       = @CC@
SUBPROGRAM  = @SUBPROGRAM@
CFLAGS   = @CFLAGS@
CPPFLAGS = @CPPFLAGS@ -I$(top_srcdir) -I$(srcdir)
LDFLAGS  = @LDFLAGS@
DEFS     = @DEFS@
LIBS     = @LIBS@
INSTALL  = @INSTALL@
MKDIR_P  = @MKDIR_P@
RANLIB   = @RANLIB@
MKDEP	 = @MKDEP@

CFLAGS  += -DDEBUG -ggdb3
CFLAGS  += -fno-strict-aliasing -Wstrict-aliasing
CFLAGS  += -Wformat=2 -Wreturn-type
CFLAGS  += -Wbad-function-cast
CFLAGS  += -Wcast-qual -Wchar-subscripts -Winline
CFLAGS  += -Wmissing-prototypes -Wnested-externs -Wpointer-arith
CFLAGS  += -Wredundant-decls -Wshadow -Wstrict-prototypes -Wwrite-strings
CFLAGS  += -Wno-error=cast-align

source   = istgt.c istgt_iscsi.c istgt_iscsi_param.c \
	istgt_lu.c istgt_cmd_table.c istgt_ser_table.c istgt_lu_disk.c istgt_lu_disk_xcopy.c istgt_lu_disk_vbox.c \
	istgt_lu_ctl.c \
	istgt_log.c istgt_conf.c istgt_sock.c istgt_misc.c \
	istgt_queue.c istgt_crc32c.c istgt_md5.c replication.c replication_misc.c \
	ring_mempool.c rte_ring.c data_conn.c

header   = istgt_ver.h istgt.h istgt_iscsi.h istgt_iscsi_xcopy.h istgt_iscsi_param.h \
	istgt_scsi.h istgt_proto.h istgt_lu.h \
	istgt_log.h istgt_conf.h istgt_sock.h \
	istgt_misc.h istgt_queue.h istgt_crc32c.h istgt_md5.h replication.h  istgt_integration.h \
	rte_atomic_64.h  rte_atomic_generic.h  rte_atomic.h  rte_common.h  \
	rte_memory.h  rte_pause.h  rte_ring.h rte_mempool.h
document = 
sample   = 

ctl_source = istgtcontrol.c istgt_conf.c istgt_log.c istgt_sock.c istgt_misc.c \
	istgt_md5.c
ctl_header = istgt_ver.h istgt_conf.h istgt_log.h istgt_sock.h istgt_misc.h \
	istgt_md5.h

istgt_integration_source  = istgt_integration_test.c mock_client.c replication.c replication_misc.c rte_ring.c \
	ring_mempool.c data_conn.c istgt_misc.c

replication_test_source   = replication_test.c replication_misc.c
replication_test_header   = replication.h istgt_integration.h

mempool_test_source = rte_ring.c mempool_test.c ring_mempool.c

ISTGT    = $(source:.c=.o)
ISTGTCONTROL = $(ctl_source:.c=.o)
REPLICATION_TEST = $(replication_test_source:.c=.o)
ISTGT_INTEGRATION = $(istgt_integration_source:.c=.o)
MEMPOOL_TEST = $(mempool_test_source:.c=.o)

PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_STRING = @PACKAGE_STRING@
PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_VERSION = @PACKAGE_VERSION@

VER_H = istgt_ver.h
DISTBASE = istgt
DISTVER  = `sed -e '/ISTGT_VERSION/!d' -e 's/[^0-9.]*\([0-9.a-z]*\).*/\1/' $(VER_H)`
DISTEXTVER = `sed -e '/ISTGT_EXTRA_VERSION/!d' -e 's/[^0-9.]*\([0-9.a-z]*\).*/\1/' $(VER_H)`
#DISTDIR  = $(PACKAGE_NAME)-$(PACKAGE_VERSION)
#DISTDIR  = $(DISTBASE)-$(DISTVER)-$(DISTEXTVER)
#DISTDIR  = $(DISTBASE)-$(DISTEXTVER)
DISTDIR = $(top_srcdir)/`cat $(top_srcdir)/distdir`
DISTNAME = $(DISTDIR).tar.gz
DISTFILES = Makefile.in config.h.in build.h.in \
	$(header) $(source) $(ctl_header) $(ctl_source) \
	$(document) $(sample)

#########################################################################

.SUFFIXES: .c .o
.c.o:
	$(CC) $(DEFS) $(CFLAGS) $(CPPFLAGS) -c -o $@ $<

.PHONY: all install install-dirs

default: all;

istgt: $(ISTGT)
	$(CC) $(LDFLAGS) -o ${@}.full $(ISTGT) $(LIBS)
	objcopy --only-keep-debug ${@}.full ${@}.debug
	objcopy --strip-debug --add-gnu-debuglink=${@}.debug ${@}.full ${@}

istgtcontrol: $(ISTGTCONTROL)
	$(CC) $(LDFLAGS) -o ${@}.full $(ISTGTCONTROL) $(LIBS)
	objcopy --only-keep-debug ${@}.full ${@}.debug
	objcopy --strip-debug --add-gnu-debuglink=${@}.debug ${@}.full ${@}

replication_test: $(REPLICATION_TEST)
	$(CC) $(LDFLAGS) -o ${@}.full $(REPLICATION_TEST) $(LIBS)
	objcopy --only-keep-debug ${@}.full ${@}.debug
	objcopy --strip-debug --add-gnu-debuglink=${@}.debug ${@}.full ${@}

istgt_integration: $(ISTGT_INTEGRATION)
	$(CC) $(LDFLAGS) -o ${@}.full $(ISTGT_INTEGRATION) $(LIBS)
	objcopy --only-keep-debug ${@}.full ${@}.debug
	objcopy --strip-debug --add-gnu-debuglink=${@}.debug ${@}.full ${@}

mempool_test: $(MEMPOOL_TEST)
	$(CC) $(LDFLAGS) -o ${@}.full $(MEMPOOL_TEST) $(LIBS)
	objcopy --only-keep-debug ${@}.full ${@}.debug
	objcopy --strip-debug --add-gnu-debuglink=${@}.debug ${@}.full ${@}

build_image:
	sh ./package.sh

all: stamp-depend config.h $(SUBPROGRAM) istgtcontrol istgt istgt_integration replication_test mempool_test build_image
dev: stamp-depend config.h $(SUBPROGRAM) istgtcontrol istgt replication_test mempool_test

install: install-dirs
	$(INSTALL) -m 0755 istgt $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 istgtcontrol $(DESTDIR)$(bindir)

install-dirs:
	$(MKDIR_P) $(DESTDIR)$(bindir)

.PHONY: dist clean distclean depend
dist: $(DISTFILES)
	if [ -f "$(top_srcdir)/distdir" ]; then \
		$(MKDIR_P) $(DISTDIR)/$(subdir) \
		cd $(srcdir); thisdir=`pwd`; \
		for file in `echo $(DISTFILES) | sort`; do \
		    cp -p $$thisdir/$$file $(DISTDIR)/$(subdir); \
		done \
	fi

depend:
	wget -O ${srcdir}/zrepl_prot.h https://raw.githubusercontent.com/openebs/zfs/zfs-0.7-release/include/zrepl_prot.h >> /dev/null 2>&1
	#As of now openebs/zfs/zfs-0.7-release doesn't support ZVOL_OP_FLAG_READ_METADATA. We need to modify zrepl_prot.h to support ZVOL_OP_FLAG_READ_METADATA.
	cat  ${srcdir}/zrepl_prot.h | grep ZVOL_OP_FLAG_READ_METADATA >> /dev/null 2>&1 || sed -i '/ZVOL_OP_FLAG_REBUILD/ a #define ZVOL_OP_FLAG_READ_METADATA 0x02' ${srcdir}/zrepl_prot.h
	if [ "x$(MKDEP)" != "x" ]; then \
		$(MKDEP) -MM $(DEFS) $(CFLAGS) $(CPPFLAGS) $(source); \
	fi
	touch stamp-depend

clean:
	-rm -f a.out *.o *.core
	-rm -f *~
	-rm -f istgt istgtcontrol
	-rm -f istgt.debug istgtcontrol.debug
	-rm -f istgt.full istgtcontrol.full
	-rm -f mempool_test
	-rm -f replication_test replication_test.debug replication_test.full

distclean: clean
	-rm -f stamp-depend .depend
	-rm -f stamp-h.in
	-rm -f Makefile config.status config.cache config.log config.h
	-rm -f build.h

#########################################################################

stamp-depend: Makefile
	$(MAKE) depend

#########################################################################
